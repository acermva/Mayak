<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–£—á—ë—Ç –Ω–∞—Ä–∞–±–æ—Ç–∫–∏ –¢–°</title>
  <style>
    :root {
      --primary: #1976d2;
      --light-bg: #f8f9fa;
      --filter-bg: #e8f5e9;
      --border: #555;
    }

    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 10px;
      background-color: #fafafa;
      color: #333;
    }

    h2 {
      text-align: center;
      margin: 10px 0;
      font-size: 1.4em;
      color: var(--primary);
    }

    .controls {
      background: var(--light-bg);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .controls > * {
      flex: 1 1 auto;
      min-width: 120px;
    }

    .controls label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: bold;
    }

    .controls input[type="month"] {
      padding: 6px;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    button {
      padding: 8px 14px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 0.95em;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover { background: #1565c0; }
    button:active { transform: scale(0.98); }

    .filters {
      background: var(--filter-bg);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 12px;
    }

    .filters > strong {
      display: block;
      margin-bottom: 8px;
      color: #2e7d32;
      font-weight: bold;
    }

    .checkbox-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      white-space: nowrap;
      min-width: 90px;
    }

    .checkbox-item input {
      margin-right: 4px;
      transform: scale(1.2);
    }

    #applyFiltersBtn {
      background: #388e3c;
      margin-top: 8px;
      padding: 8px 16px;
    }

    #exportBtn {
      background: #5d4037;
    }

    #periodTitle {
      font-weight: bold;
      color: var(--primary);
      text-align: center;
      margin: 8px 0;
      font-size: 1.1em;
    }

    #status {
      color: green;
      font-weight: bold;
      text-align: center;
      margin: 4px 0;
      min-height: 1.4em;
    }

    /* –¢–∞–±–ª–∏—Ü–∞ */
    .table-wrapper {
      overflow-x: auto;
      background: white;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      -webkit-overflow-scrolling: touch;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px;
      font-size: 0.95em;
    }

    th, td {
      border: 1px solid var(--border);
      padding: 8px 6px;
      text-align: center;
    }

    .group-header th {
      background-color: #90caf9;
      font-weight: bold;
    }

    .sub-header th {
      background-color: #bbdefb;
      font-size: 0.85em;
    }

    input {
      width: 60px;
      text-align: center;
      padding: 6px 4px;
      font-size: 1em;
      border: 1px solid #999;
      border-radius: 4px;
    }

    .total-row {
      font-weight: bold;
      background-color: #c8e6c9;
    }

    tr.today {
      background-color: #fff9c4 !important;
    }

    @media (max-width: 768px) {
      .controls {
        flex-direction: column;
        align-items: stretch;
      }
      .controls > * { min-width: auto; }
      .checkbox-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      input { width: 70px; padding: 8px 4px; }
      th, td { padding: 6px 4px; font-size: 0.85em; }
      .group-header th, .sub-header th { padding: 4px 2px; }
    }

    @media (max-width: 480px) {
      .checkbox-grid {
        grid-template-columns: 1fr;
      }
      h2 { font-size: 1.2em; }
      input { width: 80px; font-size: 1.1em; }
    }
  </style>
</head>
<body>

<h2>–£—á—ë—Ç –Ω–∞—Ä–∞–±–æ—Ç–∫–∏ —Ç–µ—Ö–Ω–∏–∫–∏ —Å–≤—è–∑–∏</h2>

<div class="controls">
  <label>
    <span>–ü–µ—Ä–∏–æ–¥:</span>
    <input type="month" id="monthPicker">
  </label>
  <button id="loadBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
  <button id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  <button id="exportBtn">–≠–∫—Å–ø–æ—Ä—Ç –≤ CSV</button>
</div>

<div id="status"></div>
<div id="periodTitle"></div>

<!-- –§–∏–ª—å—Ç—Ä—ã -->
<div class="filters">
  <strong>–û—Ç–æ–±—Ä–∞–∂–∞—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞ —Å–≤—è–∑–∏:</strong>
  <div class="checkbox-grid" id="filtersContainer"></div>
  <button id="applyFiltersBtn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
</div>

<!-- –¢–∞–±–ª–∏—Ü–∞ –≤ –æ–±—ë—Ä—Ç–∫–µ –¥–ª—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ -->
<div class="table-wrapper">
  <table id="dataTable">
    <thead>
      <tr class="group-header"><th>–î–∞—Ç–∞</th></tr>
      <tr class="sub-header"><th></th></tr>
    </thead>
    <tbody><tr><td>–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr></tbody>
  </table>
</div>

<script>
  const allStations = [
    { id: 1,  type: 'h'  }, { id: 2,  type: 'h'  }, { id: 3,  type: 'h'  },
    { id: 5,  type: 'hs' }, { id: 7,  type: 'hs' }, { id: 8,  type: 'hs' },
    { id: 9,  type: 'hs' }, { id: 10, type: 'hs' }, { id: 11, type: 'hs' },
    { id: 12, type: 'hs' }, { id: 13, type: 'h'  }, { id: 15, type: 'hs' },
    { id: 18, type: 'hs' }, { id: 19, type: 'h'  }, { id: 20, type: 'h'  }
  ];

  let currentMonth = '';
  let visibleStations = [...allStations];
  let data = {};

  const monthNames = [
    '—è–Ω–≤–∞—Ä—è', '—Ñ–µ–≤—Ä–∞–ª—è', '–º–∞—Ä—Ç–∞', '–∞–ø—Ä–µ–ª—è', '–º–∞—è', '–∏—é–Ω—è',
    '–∏—é–ª—è', '–∞–≤–≥—É—Å—Ç–∞', '—Å–µ–Ω—Ç—è–±—Ä—è', '–æ–∫—Ç—è–±—Ä—è', '–Ω–æ—è–±—Ä—è', '–¥–µ–∫–∞–±—Ä—è'
  ];

  // === –§–ò–õ–¨–¢–†–´ ===
  function initFilters() {
    const saved = localStorage.getItem('ts-visible');
    if (saved) {
      try {
        const ids = JSON.parse(saved);
        visibleStations = allStations.filter(st => ids.includes(st.id));
        if (visibleStations.length === 0) visibleStations = [...allStations];
      } catch (e) {
        visibleStations = [...allStations];
      }
    }
    renderFilters();
  }

  function renderFilters() {
    const container = document.getElementById('filtersContainer');
    container.innerHTML = '';
    allStations.forEach(st => {
      const label = document.createElement('label');
      label.className = 'checkbox-item';
      const chk = document.createElement('input');
      chk.type = 'checkbox';
      chk.dataset.id = st.id;
      chk.checked = visibleStations.some(s => s.id === st.id);
      const span = document.createElement('span');
      span.textContent = `‚Ññ${st.id}`;
      label.append(chk, span);
      container.appendChild(label);
    });
  }

  // === –î–ê–ù–ù–´–ï ===
  function getDaysInMonthUTC(year, monthZeroBased) {
    const days = [];
    let d = new Date(Date.UTC(year, monthZeroBased, 1));
    while (d.getUTCMonth() === monthZeroBased) {
      days.push(d.toISOString().slice(0, 10));
      d = new Date(d.getTime() + 86400000);
    }
    return days;
  }

  function loadData() {
    const saved = localStorage.getItem('ts-data-v5');
    if (saved) {
      try {
        data = JSON.parse(saved);
      } catch (e) {
        data = {};
      }
    }
  }

  function saveData() {
    localStorage.setItem('ts-data-v5', JSON.stringify(data));
    showStatus('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
  }

  function showStatus(msg) {
    const el = document.getElementById('status');
    el.textContent = msg;
    setTimeout(() => { if (el.textContent === msg) el.textContent = ''; }, 2000);
  }

  function ensureDateEntry(date) {
    if (!data[date]) data[date] = {};
    allStations.forEach(st => {
      if (!data[date][st.id]) {
        data[date][st.id] = st.type === 'h' 
          ? { hours: '' } 
          : { hours: '', sessions: '' };
      }
    });
  }

  function recalculateTotals() {
    const totals = {};
    visibleStations.forEach(st => {
      totals[st.id] = st.type === 'h' 
        ? { hours: 0 } 
        : { hours: 0, sessions: 0 };
    });

    Object.entries(data).forEach(([date, stationData]) => {
      if (!date.startsWith(currentMonth)) return;
      visibleStations.forEach(st => {
        const entry = stationData[st.id] || {};
        totals[st.id].hours += entry.hours || 0;
        if (st.type === 'hs') {
          totals[st.id].sessions += entry.sessions || 0;
        }
      });
    });

    const tfoot = document.querySelector('#dataTable tfoot tr');
    if (!tfoot) return;

    let cellIndex = 1;
    visibleStations.forEach(st => {
      tfoot.children[cellIndex].textContent = totals[st.id].hours;
      cellIndex++;
      if (st.type === 'hs') {
        tfoot.children[cellIndex].textContent = totals[st.id].sessions;
        cellIndex++;
      }
    });
  }

  // === –†–ï–ù–î–ï–† ===
  function renderTable() {
    if (visibleStations.length === 0) {
      document.getElementById('dataTable').innerHTML = `
        <tr><td colspan="100">–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤–æ —Å–≤—è–∑–∏</td></tr>`;
      return;
    }

    const [year, monthNum] = currentMonth.split('-').map(Number);
    const monthZeroBased = monthNum - 1;
    const days = getDaysInMonthUTC(year, monthZeroBased);
    const todayISO = new Date().toISOString().slice(0, 10);

    document.getElementById('periodTitle').textContent =
      `${monthNames[monthZeroBased]} ${year} (${days.length} –¥–Ω.)`;

    const table = document.getElementById('dataTable');
    table.innerHTML = '';

    const thead = table.createTHead();
    const row1 = thead.insertRow();
    const row2 = thead.insertRow();

    row1.insertCell().textContent = '–î–∞—Ç–∞';
    row2.insertCell().textContent = '';

    visibleStations.forEach(st => {
      const label = `‚Ññ${st.id}`;
      if (st.type === 'h') {
        const th1 = row1.insertCell();
        th1.textContent = label;
        th1.rowSpan = 2;
        th1.style.verticalAlign = 'middle';
      } else {
        const th1 = row1.insertCell();
        th1.textContent = label;
        th1.colSpan = 2;
        th1.style.textAlign = 'center';
        row2.insertCell().textContent = '–ß–∞—Å—ã';
        row2.insertCell().textContent = '–°–µ–∞–Ω—Å—ã';
      }
    });

    row1.classList.add('group-header');
    row2.classList.add('sub-header');

    const tbody = table.createTBody();
    days.forEach(date => {
      ensureDateEntry(date);
      const row = tbody.insertRow();
      if (date === todayISO) row.classList.add('today');

      row.insertCell().textContent = date;

      visibleStations.forEach(st => {
        const entry = data[date][st.id];
        if (st.type === 'h') {
          const cell = row.insertCell();
          const inp = document.createElement('input');
          inp.type = 'number'; inp.min = 0; inp.step = 1;
          inp.value = entry.hours;
          inp.dataset.date = date; inp.dataset.station = st.id; inp.dataset.field = 'hours';
          inp.addEventListener('input', handleInput);
          cell.appendChild(inp);
        } else {
          const cellH = row.insertCell();
          const inpH = document.createElement('input');
          inpH.type = 'number'; inpH.min = 0; inpH.step = 1;
          inpH.value = entry.hours;
          inpH.dataset.date = date; inpH.dataset.station = st.id; inpH.dataset.field = 'hours';
          inpH.addEventListener('input', handleInput);
          cellH.appendChild(inpH);

          const cellS = row.insertCell();
          const inpS = document.createElement('input');
          inpS.type = 'number'; inpS.min = 0; inpS.step = 1;
          inpS.value = entry.sessions;
          inpS.dataset.date = date; inpS.dataset.station = st.id; inpS.dataset.field = 'sessions';
          inpS.addEventListener('input', handleInput);
          cellS.appendChild(inpS);
        }
      });
    });

    const tfoot = table.createTFoot();
    const totalRow = tfoot.insertRow();
    totalRow.classList.add('total-row');
    totalRow.insertCell().textContent = '–ò—Ç–æ–≥–æ:';

    visibleStations.forEach(st => {
      totalRow.insertCell().textContent = '0';
      if (st.type === 'hs') {
        totalRow.insertCell().textContent = '0';
      }
    });

    recalculateTotals();
  }

  function handleInput(e) {
    const date = e.target.dataset.date;
    const stationId = e.target.dataset.station;
    const field = e.target.dataset.field;
    const value = e.target.value === '' ? '' : Number(e.target.value);

    if (!data[date]) data[date] = {};
    if (!data[date][stationId]) {
      const st = allStations.find(s => s.id == stationId);
      data[date][stationId] = st.type === 'h' 
        ? { hours: '' } 
        : { hours: '', sessions: '' };
    }
    data[date][stationId][field] = value;
    recalculateTotals();
  }

  // === –≠–ö–°–ü–û–†–¢ –í CSV ===
  function exportToCSV() {
    if (!currentMonth) return showStatus('‚ùå –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –ø–µ—Ä–∏–æ–¥');
    if (visibleStations.length === 0) return showStatus('‚ùå –ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –¢–°');

    const [year, monthNum] = currentMonth.split('-').map(Number);
    const days = getDaysInMonthUTC(year, monthNum - 1);

    // –ó–∞–≥–æ–ª–æ–≤–∫–∏
    const headers = ['–î–∞—Ç–∞'];
    visibleStations.forEach(st => {
      if (st.type === 'h') {
        headers.push(`‚Ññ${st.id} (—á)`);
      } else {
        headers.push(`‚Ññ${st.id} (—á)`, `‚Ññ${st.id} (—Å)`);
      }
    });

    // –°—Ç—Ä–æ–∫–∏
    const rows = [];
    days.forEach(date => {
      const row = [date];
      visibleStations.forEach(st => {
        const entry = data[date]?.[st.id] || {};
        if (st.type === 'h') {
          row.push(entry.hours !== '' ? entry.hours : '');
        } else {
          row.push(entry.hours !== '' ? entry.hours : '');
          row.push(entry.sessions !== '' ? entry.sessions : '');
        }
      });
      rows.push(row);
    });

    // –ò—Ç–æ–≥–∏
    const totals = ['–ò—Ç–æ–≥–æ:'];
    visibleStations.forEach(st => {
      let h = 0, s = 0;
      days.forEach(date => {
        const e = data[date]?.[st.id] || {};
        h += e.hours || 0;
        if (st.type === 'hs') s += e.sessions || 0;
      });
      totals.push(h);
      if (st.type === 'hs') totals.push(s);
    });
    rows.push(totals);

    // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ CSV
    const csvContent = [
      headers.join(';'),
      ...rows.map(r => r.map(cell => 
        typeof cell === 'string' ? `"${cell.replace(/"/g, '""')}"` : cell
      ).join(';'))
    ].join('\n');

    // UTF-8 BOM –¥–ª—è Excel
    const bom = '\uFEFF';
    const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    const monthName = monthNames[monthNum - 1];
    link.setAttribute('href', url);
    link.setAttribute('download', `–£—á—ë—Ç_–¢–°_${monthName}_${year}.csv`);
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    showStatus('üì§ –≠–∫—Å–ø–æ—Ä—Ç –Ω–∞—á–∞—Ç...');
  }

  // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
  window.addEventListener('DOMContentLoaded', () => {
    loadData();
    initFilters();

    const now = new Date(2025, 11, 14);
    const isoMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    document.getElementById('monthPicker').value = isoMonth;
    loadMonth(isoMonth);
  });

  function loadMonth(monthStr) {
    currentMonth = monthStr;
    renderTable();
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
  document.getElementById('loadBtn').addEventListener('click', () => {
    const val = document.getElementById('monthPicker').value;
    if (!val) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü –∏ –≥–æ–¥');
    loadMonth(val);
  });

  document.getElementById('saveBtn').addEventListener('click', saveData);
  document.getElementById('exportBtn').addEventListener('click', exportToCSV);

  // –§–∏–ª—å—Ç—Ä—ã
  document.getElementById('filtersContainer').addEventListener('change', e => {
    if (e.target.matches('input[type="checkbox"]')) {
      const id = Number(e.target.dataset.id);
      if (e.target.checked) {
        if (!visibleStations.some(s => s.id === id)) {
          visibleStations.push(allStations.find(s => s.id === id));
        }
      } else {
        visibleStations = visibleStations.filter(s => s.id !== id);
      }
    }
  });

  document.getElementById('applyFiltersBtn').addEventListener('click', () => {
    localStorage.setItem('ts-visible', JSON.stringify(visibleStations.map(s => s.id)));
    if (currentMonth) renderTable();
    showStatus('‚úÖ –§–∏–ª—å—Ç—Ä—ã –ø—Ä–∏–º–µ–Ω–µ–Ω—ã');
  });

  // –ó–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–∫—Ä—ã—Ç–∏—è
  window.addEventListener('beforeunload', e => {
    e.preventDefault();
    e.returnValue = '–ï—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –í—ã–π—Ç–∏?';
    return e.returnValue;
  });
</script>

</body>
</html>