<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–£—á—ë—Ç –Ω–∞—Ä–∞–±–æ—Ç–∫–∏ –¢–°</title>
  <style>
    :root {
      --primary: #1976d2;
      --light-bg: #f8f9fa;
      --filter-bg: #e8f5e9;
      --date-filter-bg: #e3f2fd;
      --border: #555;
    }

    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 10px;
      background-color: #fafafa;
      color: #333;
    }

    h2 {
      text-align: center;
      margin: 10px 0;
      font-size: 1.4em;
      color: var(--primary);
    }

    .controls {
      background: var(--light-bg);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .controls label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: bold;
    }

    .controls input[type="month"] {
      padding: 6px;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    button {
      padding: 8px 14px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 0.95em;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover { background: #1565c0; }
    button:active { transform: scale(0.98); }
    .btn-save { background: var(--primary); }
    .btn-export { background: #5d4037; }
    .btn-apply { background: #388e3c; }
    .btn-clear {
      background: #e53935;
      padding: 4px 8px;
      font-size: 0.8em;
      margin-left: 4px;
      border-radius: 3px;
    }
    .btn-clear:hover { background: #c62828; }

    .filters-section {
      background: var(--filter-bg);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 12px;
    }

    .filters-section h3 {
      margin: 0 0 8px 0;
      font-size: 1em;
      color: #2e7d32;
    }

    .checkbox-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      white-space: nowrap;
      min-width: 60px;
    }

    .checkbox-item input {
      margin-right: 4px;
      transform: scale(1.1);
    }

    #periodTitle {
      font-weight: bold;
      color: var(--primary);
      text-align: center;
      margin: 8px 0;
      font-size: 1.1em;
    }

    #status {
      color: green;
      font-weight: bold;
      text-align: center;
      margin: 4px 0;
      min-height: 1.4em;
    }

    /* –¢–∞–±–ª–∏—Ü–∞ */
    .table-wrapper {
      overflow-x: auto;
      background: white;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      -webkit-overflow-scrolling: touch;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px;
      font-size: 0.95em;
    }

    th, td {
      border: 1px solid var(--border);
      padding: 8px 6px;
      text-align: center;
    }

    .group-header th {
      background-color: #90caf9;
      font-weight: bold;
    }

    .sub-header th {
      background-color: #bbdefb;
      font-size: 0.85em;
    }

    .station-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }

    input {
      width: 60px;
      text-align: center;
      padding: 6px 4px;
      font-size: 1em;
      border: 1px solid #999;
      border-radius: 4px;
    }

    .total-row {
      font-weight: bold;
      background-color: #c8e6c9;
    }

    tr.today {
      background-color: #fff9c4 !important;
    }

    @media (max-width: 768px) {
      .controls { flex-direction: column; align-items: stretch; }
      .checkbox-grid { gap: 4px; }
      .checkbox-item { min-width: 50px; font-size: 0.9em; }
      input { width: 70px; padding: 8px 4px; }
      th, td { padding: 6px 4px; font-size: 0.85em; }
      .btn-clear { padding: 3px 6px; }
    }

    @media (max-width: 480px) {
      .checkbox-grid { grid-template-columns: 1fr; }
      h2 { font-size: 1.2em; }
      input { width: 80px; font-size: 1.1em; }
    }
  </style>
</head>
<body>

<h2>–£—á—ë—Ç –Ω–∞—Ä–∞–±–æ—Ç–∫–∏ —Ç–µ—Ö–Ω–∏–∫–∏ —Å–≤—è–∑–∏</h2>

<div class="controls">
  <label>
    <span>–ü–µ—Ä–∏–æ–¥:</span>
    <input type="month" id="monthPicker">
  </label>
  <button id="loadBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
  <button id="saveBtn" class="btn-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  <button id="exportBtn" class="btn-export">–≠–∫—Å–ø–æ—Ä—Ç –≤ CSV</button>
</div>

<div id="status"></div>
<div id="periodTitle"></div>

<!-- –§–∏–ª—å—Ç—Ä—ã –ø–æ –¢–° -->
<div class="filters-section">
  <h3>–°—Ä–µ–¥—Å—Ç–≤–∞ —Å–≤—è–∑–∏</h3>
  <div class="checkbox-grid" id="tsFiltersContainer"></div>
  <button id="applyTSBtn" class="btn-apply" style="margin-top:8px;">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –¢–°</button>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã –ø–æ –¥–Ω—è–º -->
<div class="filters-section" id="dateFiltersSection" style="display:none;">
  <h3>–î–Ω–∏ –º–µ—Å—è—Ü–∞</h3>
  <div class="checkbox-grid" id="dateFiltersContainer"></div>
  <button id="applyDateBtn" class="btn-apply" style="margin-top:8px;">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –¥–∞—Ç—ã</button>
  <button id="selectAllDaysBtn" style="margin-left:6px; background:#64b5f6;">–í—Å–µ</button>
  <button id="selectWorkdaysBtn" style="margin-left:6px; background:#4fc3f7;">–†–∞–±–æ—á–∏–µ</button>
</div>

<!-- –¢–∞–±–ª–∏—Ü–∞ -->
<div class="table-wrapper">
  <table id="dataTable">
    <thead>
      <tr class="group-header"><th>–î–∞—Ç–∞</th></tr>
      <tr class="sub-header"><th></th></tr>
    </thead>
    <tbody><tr><td>–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr></tbody>
  </table>
</div>

<script>
  const allStations = [
    { id: 1,  type: 'h'  }, { id: 2,  type: 'h'  }, { id: 3,  type: 'h'  },
    { id: 5,  type: 'hs' }, { id: 7,  type: 'hs' }, { id: 8,  type: 'hs' },
    { id: 9,  type: 'hs' }, { id: 10, type: 'hs' }, { id: 11, type: 'hs' },
    { id: 12, type: 'hs' }, { id: 13, type: 'h'  }, { id: 15, type: 'hs' },
    { id: 18, type: 'hs' }, { id: 19, type: 'h'  }, { id: 20, type: 'h'  }
  ];

  let currentMonth = '';
  let visibleStations = [...allStations];
  let visibleDates = [];
  let data = {};

  const monthNames = [
    '—è–Ω–≤–∞—Ä—è', '—Ñ–µ–≤—Ä–∞–ª—è', '–º–∞—Ä—Ç–∞', '–∞–ø—Ä–µ–ª—è', '–º–∞—è', '–∏—é–Ω—è',
    '–∏—é–ª—è', '–∞–≤–≥—É—Å—Ç–∞', '—Å–µ–Ω—Ç—è–±—Ä—è', '–æ–∫—Ç—è–±—Ä—è', '–Ω–æ—è–±—Ä—è', '–¥–µ–∫–∞–±—Ä—è'
  ];

  // ‚úÖ –§–£–ù–ö–¶–ò–ò ‚Äî –ò–°–ü–†–ê–í–õ–ï–ù–´
  function getCurrentCutoffDate() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const todayISO = `${year}-${month}-${day}`;
    if (now.getHours() < 10) {
      const yesterday = new Date(now);
      yesterday.setDate(yesterday.getDate() - 1);
      return yesterday.toISOString().slice(0, 10);
    }
    return todayISO;
  }

  function autoFillForward(stationId, dateFrom, field, value) {
    const cutoffDate = getCurrentCutoffDate();
    const [year, monthNum] = currentMonth.split('-').map(Number);
    const allDays = getDaysInMonthUTC(year, monthNum - 1);
    
    const startIndex = allDays.indexOf(dateFrom);
    if (startIndex === -1) return;

    let endIndex = allDays.indexOf(cutoffDate);
    if (endIndex === -1) endIndex = allDays.length - 1;
    if (endIndex < startIndex) return;

    for (let i = startIndex + 1; i <= endIndex; i++) {
      const date = allDays[i];
      ensureDateEntry(date);
      if (data[date][stationId][field] === '') {
        data[date][stationId][field] = value;
      } else {
        break;
      }
    }
  }

  function getDaysInMonthUTC(year, monthZeroBased) {
    const days = [];
    let d = new Date(Date.UTC(year, monthZeroBased, 1));
    while (d.getUTCMonth() === monthZeroBased) {
      days.push(d.toISOString().slice(0, 10));
      d = new Date(d.getTime() + 86400000);
    }
    return days;
  }

  function loadData() {
    const saved = localStorage.getItem('ts-data-final-v2');
    if (saved) {
      try {
        data = JSON.parse(saved);
      } catch (e) {
        data = {};
      }
    }
  }

  function saveData() {
    localStorage.setItem('ts-data-final-v2', JSON.stringify(data));
    showStatus('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
  }

  function showStatus(msg) {
    const el = document.getElementById('status');
    el.textContent = msg;
    setTimeout(() => { if (el.textContent === msg) el.textContent = ''; }, 2000);
  }

  function ensureDateEntry(date) {
    if (!data[date]) data[date] = {};
    allStations.forEach(st => {
      if (!data[date][st.id]) {
        data[date][st.id] = st.type === 'h' 
          ? { hours: '' } 
          : { hours: '', sessions: '' };
      }
    });
  }

  // ‚úÖ –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ—Å–ª–µ –≤–≤–æ–¥–∞
  function processCellInput(inputEl) {
    const date = inputEl.dataset.date;
    const stationId = inputEl.dataset.station;
    const field = inputEl.dataset.field;
    const rawValue = inputEl.value.trim();
    let value = '';

    if (rawValue !== '') {
      const num = Number(rawValue);
      if (!isNaN(num) && num >= 0) {
        value = num;
        inputEl.value = num; // –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è
      } else {
        inputEl.value = '';
        return;
      }
    }

    if (!data[date]) data[date] = {};
    if (!data[date][stationId]) {
      const st = allStations.find(s => s.id == stationId);
      data[date][stationId] = st.type === 'h' 
        ? { hours: '' } 
        : { hours: '', sessions: '' };
    }
    data[date][stationId][field] = value;

    const cutoffDate = getCurrentCutoffDate();
    if (date <= cutoffDate && value !== '') {
      autoFillForward(stationId, date, field, value);
    }

    recalculateTotals();
  }

  function recalculateTotals() {
    const totals = {};
    visibleStations.forEach(st => {
      totals[st.id] = st.type === 'h' 
        ? { hours: 0 } 
        : { hours: 0, sessions: 0 };
    });

    [...visibleDates].sort().forEach(date => {
      const stationData = data[date] || {};
      visibleStations.forEach(st => {
        const entry = stationData[st.id] || {};
        totals[st.id].hours += entry.hours || 0;
        if (st.type === 'hs') {
          totals[st.id].sessions += entry.sessions || 0;
        }
      });
    });

    const tfoot = document.querySelector('#dataTable tfoot tr');
    if (!tfoot) return;

    let cellIndex = 1;
    visibleStations.forEach(st => {
      tfoot.children[cellIndex].textContent = totals[st.id].hours;
      cellIndex++;
      if (st.type === 'hs') {
        tfoot.children[cellIndex].textContent = totals[st.id].sessions;
        cellIndex++;
      }
    });
  }

  function clearStation(stationId) {
    visibleDates.forEach(date => {
      if (data[date] && data[date][stationId]) {
        const st = allStations.find(s => s.id === stationId);
        data[date][stationId] = st.type === 'h'
          ? { hours: '' }
          : { hours: '', sessions: '' };
      }
    });
    renderTable();
    recalculateTotals();
    showStatus(`üóëÔ∏è ‚Ññ${stationId} –æ—á–∏—â–µ–Ω`);
  }

  function renderTable() {
    if (visibleStations.length === 0 || visibleDates.length === 0) {
      document.getElementById('dataTable').innerHTML = `
        <tr><td colspan="100">${visibleStations.length === 0 ? '–í—ã–±–µ—Ä–∏—Ç–µ –¢–°' : '–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—ã'}</td></tr>`;
      return;
    }

    const [year, monthNum] = currentMonth.split('-').map(Number);
    const totalDays = getDaysInMonthUTC(year, monthNum - 1).length;
    document.getElementById('periodTitle').textContent =
      `${monthNames[monthNum - 1]} ${year} (${visibleDates.length} –∏–∑ ${totalDays} –¥–Ω.)`;

    const table = document.getElementById('dataTable');
    table.innerHTML = '';

    const thead = table.createTHead();
    const row1 = thead.insertRow();
    const row2 = thead.insertRow();

    row1.insertCell().textContent = '–î–∞—Ç–∞';
    row2.insertCell().textContent = '';

    visibleStations.forEach(st => {
      const label = `‚Ññ${st.id}`;
      if (st.type === 'h') {
        const th1 = row1.insertCell();
        const headerDiv = document.createElement('div');
        headerDiv.className = 'station-header';
        headerDiv.innerHTML = `${label} <button class="btn-clear" data-station="${st.id}">√ó</button>`;
        th1.appendChild(headerDiv);
        th1.rowSpan = 2;
        th1.style.verticalAlign = 'middle';
      } else {
        const th1 = row1.insertCell();
        const headerDiv = document.createElement('div');
        headerDiv.className = 'station-header';
        headerDiv.innerHTML = `${label} <button class="btn-clear" data-station="${st.id}">√ó</button>`;
        th1.appendChild(headerDiv);
        th1.colSpan = 2;
        th1.style.textAlign = 'center';
        row2.insertCell().textContent = '–ß–∞—Å—ã';
        row2.insertCell().textContent = '–°–µ–∞–Ω—Å—ã';
      }
    });

    row1.classList.add('group-header');
    row2.classList.add('sub-header');

    const tbody = table.createTBody();
    const todayISO = new Date().toISOString().slice(0, 10);

    [...visibleDates].sort().forEach(date => {
      ensureDateEntry(date);
      const row = tbody.insertRow();
      if (date === todayISO) row.classList.add('today');

      row.insertCell().textContent = date;

      visibleStations.forEach(st => {
        const entry = data[date][st.id];
        if (st.type === 'h') {
          const cell = row.insertCell();
          const inp = document.createElement('input');
          inp.type = 'number'; inp.min = 0; inp.step = 1;
          inp.value = entry.hours;
          inp.dataset.date = date; inp.dataset.station = st.id; inp.dataset.field = 'hours';

          // ‚úÖ –¢–æ–ª—å–∫–æ –ø–æ Enter –∏ Blur
          inp.addEventListener('keydown', e => {
            if (e.key === 'Enter') {
              e.preventDefault();
              processCellInput(inp);
            }
          });
          inp.addEventListener('blur', () => {
            processCellInput(inp);
          });

          cell.appendChild(inp);
        } else {
          const cellH = row.insertCell();
          const inpH = document.createElement('input');
          inpH.type = 'number'; inpH.min = 0; inpH.step = 1;
          inpH.value = entry.hours;
          inpH.dataset.date = date; inpH.dataset.station = st.id; inpH.dataset.field = 'hours';
          
          inpH.addEventListener('keydown', e => {
            if (e.key === 'Enter') {
              e.preventDefault();
              processCellInput(inpH);
            }
          });
          inpH.addEventListener('blur', () => {
            processCellInput(inpH);
          });
          cellH.appendChild(inpH);

          const cellS = row.insertCell();
          const inpS = document.createElement('input');
          inpS.type = 'number'; inpS.min = 0; inpS.step = 1;
          inpS.value = entry.sessions;
          inpS.dataset.date = date; inpS.dataset.station = st.id; inpS.dataset.field = 'sessions';
          
          inpS.addEventListener('keydown', e => {
            if (e.key === 'Enter') {
              e.preventDefault();
              processCellInput(inpS);
            }
          });
          inpS.addEventListener('blur', () => {
            processCellInput(inpS);
          });
          cellS.appendChild(inpS);
        }
      });
    });

    const tfoot = table.createTFoot();
    const totalRow = tfoot.insertRow();
    totalRow.classList.add('total-row');
    totalRow.insertCell().textContent = '–ò—Ç–æ–≥–æ:';

    visibleStations.forEach(st => {
      totalRow.insertCell().textContent = '0';
      if (st.type === 'hs') {
        totalRow.insertCell().textContent = '0';
      }
    });

    document.querySelectorAll('.btn-clear').forEach(btn => {
      btn.addEventListener('click', e => {
        e.stopPropagation();
        const stationId = Number(e.target.dataset.station);
        if (confirm(`–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–æ ‚Ññ${stationId}?`)) {
          clearStation(stationId);
        }
      });
    });

    recalculateTotals();
  }

  // === –û–°–¢–ê–õ–¨–ù–û–ï –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô ===
  function exportToCSV() {
    if (visibleStations.length === 0 || visibleDates.length === 0) {
      return showStatus('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –¢–° –∏ –¥–∞—Ç—ã');
    }

    const headers = ['–î–∞—Ç–∞'];
    visibleStations.forEach(st => {
      if (st.type === 'h') {
        headers.push(`‚Ññ${st.id} (—á)`);
      } else {
        headers.push(`‚Ññ${st.id} (—á)`, `‚Ññ${st.id} (—Å)`);
      }
    });

    const rows = [...visibleDates].sort().map(date => {
      const row = [date];
      visibleStations.forEach(st => {
        const entry = data[date]?.[st.id] || {};
        if (st.type === 'h') {
          row.push(entry.hours !== '' ? entry.hours : '');
        } else {
          row.push(entry.hours !== '' ? entry.hours : '');
          row.push(entry.sessions !== '' ? entry.sessions : '');
        }
      });
      return row;
    });

    const totals = ['–ò—Ç–æ–≥–æ:'];
    visibleStations.forEach(st => {
      let h = 0, s = 0;
      [...visibleDates].sort().forEach(date => {
        const e = data[date]?.[st.id] || {};
        h += e.hours || 0;
        if (st.type === 'hs') s += e.sessions || 0;
      });
      totals.push(h);
      if (st.type === 'hs') totals.push(s);
    });
    rows.push(totals);

    const csvContent = [
      headers.join(';'),
      ...rows.map(r => r.map(cell => 
        typeof cell === 'string' ? `"${cell.replace(/"/g, '""')}"` : cell
      ).join(';'))
    ].join('\n');

    const bom = '\uFEFF';
    const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    const [year, monthNum] = currentMonth.split('-').map(Number);
    const monthName = monthNames[monthNum - 1];
    link.href = url;
    link.download = `–£—á—ë—Ç_–¢–°_${monthName}_${year}.csv`;
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    showStatus('üì§ –≠–∫—Å–ø–æ—Ä—Ç –Ω–∞—á–∞—Ç...');
  }

  function initTSFilters() {
    const saved = localStorage.getItem('ts-visible');
    if (saved) {
      try {
        const ids = JSON.parse(saved);
        visibleStations = allStations.filter(st => ids.includes(st.id));
        if (visibleStations.length === 0) visibleStations = [...allStations];
      } catch (e) {
        visibleStations = [...allStations];
      }
    }
    renderTSFilters();
  }

  function renderTSFilters() {
    const container = document.getElementById('tsFiltersContainer');
    container.innerHTML = '';
    allStations.forEach(st => {
      const label = document.createElement('label');
      label.className = 'checkbox-item';
      const chk = document.createElement('input');
      chk.type = 'checkbox';
      chk.dataset.id = st.id;
      chk.checked = visibleStations.some(s => s.id === st.id);
      const span = document.createElement('span');
      span.textContent = `‚Ññ${st.id}`;
      label.append(chk, span);
      container.appendChild(label);
    });
  }

  function renderDateFilters(days) {
    const section = document.getElementById('dateFiltersSection');
    const container = document.getElementById('dateFiltersContainer');
    section.style.display = 'block';
    
    container.innerHTML = '';
    days.forEach(dateStr => {
      const dayNum = dateStr.slice(8);
      const label = document.createElement('label');
      label.className = 'checkbox-item';
      const chk = document.createElement('input');
      chk.type = 'checkbox';
      chk.dataset.date = dateStr;
      chk.checked = visibleDates.includes(dateStr);
      const span = document.createElement('span');
      span.textContent = dayNum;
      label.append(chk, span);
      container.appendChild(label);
    });
  }

  function selectWorkdays(days) {
    return days.filter(dateStr => {
      const d = new Date(dateStr);
      const day = d.getDay();
      return day !== 0 && day !== 6;
    });
  }

  window.addEventListener('DOMContentLoaded', () => {
    loadData();
    initTSFilters();

    const now = new Date(2025, 11, 14);
    const isoMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    document.getElementById('monthPicker').value = isoMonth;

    const savedDates = localStorage.getItem('ts-visible-dates');
    if (savedDates) {
      try {
        const datesArr = JSON.parse(savedDates);
        if (datesArr.length > 0) {
          const monthFromSaved = datesArr[0].slice(0, 7);
          currentMonth = monthFromSaved;
          visibleDates = datesArr.filter(d => d.startsWith(monthFromSaved));
          document.getElementById('monthPicker').value = monthFromSaved;
          const [year, monthNum] = monthFromSaved.split('-').map(Number);
          const days = getDaysInMonthUTC(year, monthNum - 1);
          renderDateFilters(days);
          renderTable();
          return;
        }
      } catch (e) {
        console.warn('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞ –¥–∞—Ç', e);
      }
    }

    currentMonth = isoMonth;
    loadMonth(isoMonth);
  });

  function loadMonth(monthStr) {
    const isManualChange = (monthStr !== currentMonth);
    currentMonth = monthStr;
    
    const [year, monthNum] = monthStr.split('-').map(Number);
    const days = getDaysInMonthUTC(year, monthNum - 1);
    
    if (isManualChange) {
      visibleDates = [...days];
      localStorage.setItem('ts-visible-dates', JSON.stringify(visibleDates));
    } else {
      visibleDates = visibleDates.filter(d => d.startsWith(monthStr));
      if (visibleDates.length === 0) {
        visibleDates = [...days];
      }
    }

    renderDateFilters(days);
    renderTable();
  }

  document.getElementById('loadBtn').addEventListener('click', () => {
    const val = document.getElementById('monthPicker').value;
    if (!val) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü –∏ –≥–æ–¥');
    loadMonth(val);
  });

  document.getElementById('saveBtn').addEventListener('click', saveData);
  document.getElementById('exportBtn').addEventListener('click', exportToCSV);

  document.getElementById('tsFiltersContainer').addEventListener('change', e => {
    if (e.target.matches('input[type="checkbox"]')) {
      const id = Number(e.target.dataset.id);
      if (e.target.checked) {
        if (!visibleStations.some(s => s.id === id)) {
          visibleStations.push(allStations.find(s => s.id === id));
        }
      } else {
        visibleStations = visibleStations.filter(s => s.id !== id);
      }
    }
  });

  document.getElementById('applyTSBtn').addEventListener('click', () => {
    localStorage.setItem('ts-visible', JSON.stringify(visibleStations.map(s => s.id)));
    if (currentMonth) renderTable();
    showStatus('‚úÖ –¢–° –ø—Ä–∏–º–µ–Ω–µ–Ω—ã');
  });

  document.getElementById('dateFiltersContainer').addEventListener('change', e => {
    if (e.target.matches('input[type="checkbox"]')) {
      const date = e.target.dataset.date;
      if (e.target.checked) {
        if (!visibleDates.includes(date)) visibleDates.push(date);
      } else {
        visibleDates = visibleDates.filter(d => d !== date);
      }
    }
  });

  document.getElementById('applyDateBtn').addEventListener('click', () => {
    const [year, monthNum] = currentMonth.split('-').map(Number);
    const days = getDaysInMonthUTC(year, monthNum - 1);
    visibleDates = visibleDates.filter(d => days.includes(d));
    if (visibleDates.length === 0) {
      visibleDates = [...days];
    }
    localStorage.setItem('ts-visible-dates', JSON.stringify(visibleDates));
    renderTable();
    showStatus('‚úÖ –î–∞—Ç—ã –ø—Ä–∏–º–µ–Ω–µ–Ω—ã');
  });

  document.getElementById('selectAllDaysBtn').addEventListener('click', () => {
    const [year, monthNum] = currentMonth.split('-').map(Number);
    const days = getDaysInMonthUTC(year, monthNum - 1);
    visibleDates = [...days];
    const checkboxes = document.querySelectorAll('#dateFiltersContainer input[type="checkbox"]');
    checkboxes.forEach(chk => chk.checked = true);
  });

  document.getElementById('selectWorkdaysBtn').addEventListener('click', () => {
    const [year, monthNum] = currentMonth.split('-').map(Number);
    const days = getDaysInMonthUTC(year, monthNum - 1);
    const workdays = selectWorkdays(days);
    visibleDates = [...workdays];
    const checkboxes = document.querySelectorAll('#dateFiltersContainer input[type="checkbox"]');
    checkboxes.forEach(chk => {
      chk.checked = workdays.includes(chk.dataset.date);
    });
  });

  window.addEventListener('beforeunload', e => {
    e.preventDefault();
    e.returnValue = '–ï—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –í—ã–π—Ç–∏?';
    return e.returnValue;
  });
</script>

</body>
</html>
